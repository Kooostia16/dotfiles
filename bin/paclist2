#!/bin/bash

pkgfile="${DOTFILES_PATH}/packages/index"

GRAY='\033[1;30m'
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# cache installed packages.
# pacman -Qs is slow.
pkgcache=$( mktemp )
pacman -Qq > "$pkgcache"

installed () {
	grep -qe "\b$1\b" $2
	return $?
}

# https://stackoverflow.com/a/3352015
trim() {
	local var="$*"
	# remove leading whitespace characters
	var="${var#"${var%%[![:space:]]*}"}"
	# remove trailing whitespace characters
	var="${var%"${var##*[![:space:]]}"}"
	echo -n "$var"
}

cat "$pkgfile"* | while read _pkg; do
	pkg=$(echo "$_pkg" | xargs -0 )

	# empty lines, show.
	if [ "z$pkg" == "z" ]; then
		echo ""
		continue
	fi

	# comments, show.
	echo "$pkg" | grep -qe "^#"
	if [ $? -eq 0 ]; then
		printf "${NC}${BLUE}$pkg${NC}\n"
		continue
	fi

	name=$( echo "$pkg" | awk -F"::" '{ print $1 }')
	desc=$( echo "$pkg" | awk -F"::" '{ print $2 }')

	name=$( trim $name )
	desc=$( trim $desc )

	printf "${NC}${GRAY}[${NC}"

	if installed "$name" $pkgcache > /dev/null ; then
		printf "${GREEN}~${NC}"
	else
		printf "${RED}#${NC}"
	fi

	printf "${GRAY}]${NC} ${name} ${GRAY}$desc${NC}${NC}\n"

done
